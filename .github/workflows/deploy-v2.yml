name: Deploy app
on:
  workflow_dispatch:
  # push:
    # branches:
      # - 'next'
      # - 'master'
jobs:
  tests:
    name: â–¶ï¸ Tests
    runs-on: ubuntu-latest
    steps:
      - name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: âœ¨ Install
        run: npm install
      - name: ðŸ©º Testing
        run: npm run test
  build-push:
    name: â–¶ï¸ Build & push
    runs-on: ubuntu-latest
    needs: [tests]
    steps:
      - name: ðŸš§ Set short commit SHA and ENV
        run: |
          echo "TAG=${GITHUB_SHA::7}" >> $GITHUB_ENV
          if [ "${GITHUB_REF}" = "refs/heads/master" ]; then
            echo "ENV=prod" >> $GITHUB_ENV
          elif [ "${GITHUB_REF}" = "refs/heads/next" ]; then
            echo "ENV=dev" >> $GITHUB_ENV
          else
            echo "ENV=dev" >> $GITHUB_ENV
          fi
      - name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.github_token }}
      - name: ðŸ› ï¸ Build & Push Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: ghcr.io/${{ github.repository }}:${{ env.TAG }},ghcr.io/${{ github.repository }}:latest
          cache-from: type=registry,ref=ghcr.io/${{ github.repository }}:cache
          cache-to: type=inline
  deploy:
    name: â–¶ï¸ Deploy
    needs: [build-push]
    runs-on: ubuntu-latest
    steps:
      - name: ðŸš§ Set short commit SHA and ENV
        run: |
          echo "TAG=${GITHUB_SHA::7}" >> $GITHUB_ENV
          if [ "${GITHUB_REF}" = "refs/heads/master" ]; then
            echo "ENV=prod" >> $GITHUB_ENV
          elif [ "${GITHUB_REF}" = "refs/heads/next" ]; then
            echo "ENV=dev" >> $GITHUB_ENV
          else
            echo "ENV=dev" >> $GITHUB_ENV
          fi
      - name: â¬‡ï¸ Checkout Ansible
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          repository: thefirstspine/ansible
          ref: with-private-registries
      - name: ðŸ” Ansible inventory builder (dev)
        if: env.ENV == 'dev'
        run: |
          echo "
            # Auto-generated file - do not edit
            apps:
              hosts:
                app:
                  # SSH agent settings
                  ansible_connection: ssh
                  ansible_ssh_host: ${{ secrets.ansible_conf_ansible_ssh_host_dev }}
                  ansible_ssh_user: ${{ secrets.ansible_conf_ansible_ssh_user_dev }}
                  ansible_ssh_private_key_file: volume/keys/id_ansible_dev
                  ansible_ssh_host_key_checking:false
                  ansible_ssh_common_args:-o StrictHostKeyChecking=no
                  # Image settings
                  registry: ghcr.io
                  registry_username: ${{ github.actor }}
                  registry_password: ${{ secrets.github_token }}
                  image:ghcr.io/${{ github.repository }}:${{ env.TAG }}
                  # Container env
                  env: dev
                  pg_database: ${{ secrets.ansible_conf_pg_database_dev }}
                  pg_host: ${{ secrets.ansible_conf_pg_host_dev }}
                  pg_port: ${{ secrets.ansible_conf_pg_port_dev }}
                  pg_password: ${{ secrets.ansible_conf_pg_password_dev }}
                  pg_username: ${{ secrets.ansible_conf_pg_username_dev }}
                  # Host settings
                  external_port:8080
                  internal_port:8090
                  domain: dev.${{ github.event.repository.name }}.thefirstspine.fr
                  cerbot_email: ${{ secrets.ansible_conf_cerbot_email }}
          " > volume/conf/inventory.yaml
      - name: ðŸ” Write keys (dev)
        if: env.ENV == 'dev'
        run: |
          echo "${{ secrets.ansible_key_id_ansible_dev }}" > volume/keys/id_ansible
      - name: ðŸ” Ansible inventory builder (prod)
        if: env.ENV == 'prod'
        run: |
          echo "
            # Auto-generated file - do not edit
            apps:
              hosts:
                app:
                  # SSH agent settings
                  ansible_connection: ssh
                  ansible_ssh_host: ${{ secrets.ansible_conf_ansible_ssh_host_prod }}
                  ansible_ssh_user: ${{ secrets.ansible_conf_ansible_ssh_user_prod }}
                  ansible_ssh_private_key_file: volume/keys/id_ansible_prod
                  ansible_ssh_host_key_checking:false
                  ansible_ssh_common_args:-o StrictHostKeyChecking=no
                  # Image settings
                  registry: ghcr.io
                  registry_username: ${{ github.actor }}
                  registry_password: ${{ secrets.github_token }}
                  image:ghcr.io/${{ github.repository }}:${{ env.TAG }}
                  # Container env
                  env: prod
                  # Container env
                  pg_database: ${{ secrets.ansible_conf_pg_database_prod }}
                  pg_host: ${{ secrets.ansible_conf_pg_host_prod }}
                  pg_port: ${{ secrets.ansible_conf_pg_port_prod }}
                  pg_password: ${{ secrets.ansible_conf_pg_password_prod }}
                  pg_username: ${{ secrets.ansible_conf_pg_username_prod }}
                  # Host settings
                  external_port:8080
                  internal_port:8090
                  domain: prod.${{ github.event.repository.name }}.thefirstspine.fr
                  cerbot_email: ${{ secrets.ansible_conf_cerbot_email }}
          " > volume/conf/inventory.yaml
      - name: ðŸ” Write keys (prod)
        if: env.ENV == 'prod'
        run: |
          echo "${{ secrets.ansible_key_id_ansible_prod }}" > volume/keys/id_ansible
      - name: ðŸ¤– Ansible deploy
        run: |
          docker build . -t thefirstspine-org-ansible &&
          docker run --rm -v ./volume:/volume thefirstspine-org-ansible ansible-playbook -i /volume/conf/inventory.yaml /volume/playbooks/deploy-${{ github.event.repository.name }}.yaml
