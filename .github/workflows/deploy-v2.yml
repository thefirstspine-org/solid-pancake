name: Deploy app
on:
  workflow_dispatch:
  # push:
    # branches:
      # - 'next'
      # - 'master'
jobs:
  tests:
    name: ðŸ§ª Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Install
        run: npm install
      - name: Testing
        run: npm run test
  build-push:
    name: ðŸ”¥ Build & push
    runs-on: ubuntu-latest
    needs: [tests]
    steps:
      - name: Set short commit SHA and ENV
        run: |
          echo "TAG=${GITHUB_SHA::7}" >> $GITHUB_ENV
          if [ "${GITHUB_REF}" = "refs/heads/master" ]; then
            echo "ENV=prod" >> $GITHUB_ENV
          elif [ "${GITHUB_REF}" = "refs/heads/next" ]; then
            echo "ENV=dev" >> $GITHUB_ENV
          else
            echo "ENV=dev" >> $GITHUB_ENV
          fi
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.registry_token }}
      - name: Build & Push Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: ghcr.io/${{ github.repository }}:${{ env.TAG }},ghcr.io/${{ github.repository }}:latest
          cache-from: type=registry,ref=ghcr.io/${{ github.repository }}:cache
          cache-to: type=inline
  deploy:
    name: ðŸš€ Deploy
    needs: [build-push]
    runs-on: ubuntu-latest
    steps:
      - name: Set short commit SHA and ENV
        run: |
          echo "TAG=${GITHUB_SHA::7}" >> $GITHUB_ENV
          if [ "${GITHUB_REF}" = "refs/heads/master" ]; then
            echo "ENV=prod" >> $GITHUB_ENV
          elif [ "${GITHUB_REF}" = "refs/heads/next" ]; then
            echo "ENV=dev" >> $GITHUB_ENV
          else
            echo "ENV=dev" >> $GITHUB_ENV
          fi
      - name: Checkout Ansible
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          repository: thefirstspine/ansible
          ref: with-private-registries
      - name: Ansible inventory builder (dev)
        if: env.ENV == 'dev'
        run: |
          cat > ./volume/conf/inventory.yaml <<'YAML'
          # Auto-generated file - do not edit
          apps:
            hosts:
              app:
                # SSH agent settings
                ansible_connection: ssh
                ansible_ssh_host: ${{ secrets.ansible_conf_ansible_ssh_host_dev }}
                ansible_ssh_user: ${{ secrets.ansible_conf_ansible_ssh_user_dev }}
                ansible_ssh_private_key_file: volume/keys/id_ansible_dev
                ansible_ssh_host_key_checking:false
                ansible_ssh_common_args:-o StrictHostKeyChecking=no
                # Image settings
                registry: ghcr.io
                registry_username: ${{ github.actor }}
                registry_password: ${{ secrets.registry_token }}
                image:ghcr.io/${{ github.repository }}:${{ env.TAG }}
                # Container env
                env: dev
                pg_database: ${{ secrets.ansible_conf_pg_database_dev }}
                pg_host: ${{ secrets.ansible_conf_pg_host_dev }}
                pg_port: ${{ secrets.ansible_conf_pg_port_dev }}
                pg_password: ${{ secrets.ansible_conf_pg_password_dev }}
                pg_username: ${{ secrets.ansible_conf_pg_username_dev }}
                # Host settings
                external_port:8080
                internal_port:8090
                domain: dev.solid-pancake.thefirstspine.fr
                cerbot_email: ${{ secrets.ansible_conf_cerbot_email }}
          YAML
      - name: Write keys (dev)
        if: env.ENV == 'dev'
        run: |
          printf '%s\n' "${{ secrets.ansible_key_id_ansible_dev }}" > ./volume/keys/id_ansible
      - name: Ansible inventory builder (prod)
        if: env.ENV == 'prod'
        run: |
          cat > ./volume/conf/inventory.yaml <<'YAML'
          # Auto-generated file - do not edit
          apps:
            hosts:
              app:
                # SSH agent settings
                ansible_connection: ssh
                ansible_ssh_host: ${{ secrets.ansible_conf_ansible_ssh_host_prod }}
                ansible_ssh_user: ${{ secrets.ansible_conf_ansible_ssh_user_prod }}
                ansible_ssh_private_key_file: volume/keys/id_ansible_prod
                ansible_ssh_host_key_checking:false
                ansible_ssh_common_args:-o StrictHostKeyChecking=no
                # Image settings
                registry: ghcr.io
                registry_username: ${{ github.actor }}
                registry_password: ${{ secrets.registry_token }}
                image:ghcr.io/${{ github.repository }}:${{ env.TAG }}
                # Container env
                env: prod
                pg_database: ${{ secrets.ansible_conf_pg_database_prod }}
                pg_host: ${{ secrets.ansible_conf_pg_host_prod }}
                pg_port: ${{ secrets.ansible_conf_pg_port_prod }}
                pg_password: ${{ secrets.ansible_conf_pg_password_prod }}
                pg_username: ${{ secrets.ansible_conf_pg_username_prod }}
                # Host settings
                external_port:8080
                internal_port:8090
                domain: prod.solid-pancake.thefirstspine.fr
                cerbot_email: ${{ secrets.ansible_conf_cerbot_email }}
          YAML
      - name: Write keys (prod)
        if: env.ENV == 'prod'
        run: |
          printf '%s\n' "${{ secrets.ansible_key_id_ansible_prod }}" > ./volume/keys/id_ansible
      - name: Ansible deploy
        run: |
          docker build . -t thefirstspine-org-ansible &&
          docker run \
            --rm \
            -v ./volume:/volume \
            thefirstspine-org-ansible \
            ansible-playbook \
            -i /volume/conf/inventory.yaml \
            /volume/playbooks/deploy-solid-pancake.yaml
