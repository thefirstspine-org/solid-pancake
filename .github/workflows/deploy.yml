name: Deploy app
on:
  workflow_dispatch:
  push:
    branches:
      - 'next'
      - 'master'
jobs:
  prune-images:
    name: ðŸ§¹ Prune GHCR images older than 3h
    runs-on: ubuntu-latest
    steps:
      - name: Install gh & jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt-get update
          sudo apt-get install -y gh
      - name: Authenticate gh
        run: echo "${{ secrets.registry_token }}" | gh auth login --with-token
      - name: Prune images older than 3 hours
        env:
          OWNER: ${{ github.repository_owner }}
          REPO: ${{ github.repository }}
          THRESHOLD_SECS: 10800
        run: |
          set -eu
          now_ts=$(date +%s)
          echo "Pruning container package versions for $OWNER/$REPO older than $THRESHOLD_SECS seconds"
          for scope in orgs users; do
            endpoint="/$scope/$OWNER/packages/container/$REPO/versions"
            echo "Listing $endpoint"
            data=$(gh api -H "Accept: application/vnd.github.v3+json" --paginate "$endpoint" 2>/dev/null || true)
            if [ -z "$data" ] || [ "$data" = "null" ]; then
              echo "No data for $endpoint"
              continue
            fi
            echo "$data" | jq -c '.[] | {id:.id,created_at:.created_at}' | while read -r item; do
              id=$(echo "$item" | jq -r '.id')
              created=$(echo "$item" | jq -r '.created_at')
              created_ts=$(date -d "$created" +%s)
              age=$((now_ts - created_ts))
              if [ "$age" -gt "$THRESHOLD_SECS" ]; then
                echo "Deleting version $id (age ${age}s, created $created)"
                gh api -X DELETE "$endpoint/$id" || echo "Delete failed for $id"
              else
                echo "Keeping version $id (age ${age}s)"
              fi
            done
          done
